>BROM  -> SPL -> UBoot -> DTS -> Kernel -> rootfs

![[linux启动流程.png]]

## 1.BROM
 >负责执行最底层的硬件初始化和引导逻辑
 
#### 1.1硬件初始化
##### 1.1.1时钟系统配置
- 初始化芯片的主时钟源（如晶振），配置 PLL（锁相环）以生成 CPU 和外设所需的时钟频率。
- 启用必要的时钟域（如 CPU、总线、内存控制器），为后续操作提供稳定时钟。
##### 1.1.2电源管理初始化
- 配置电源管理单元（PMU），确保各硬件模块获得稳定供电。
- 设置功耗模式（如正常模式、低功耗模式），优化芯片能效。
##### 1.1.3基本安全设置
- 启用硬件安全机制（如 ARM TrustZone 的初步配置），建立安全启动环境。
- 验证第一阶段 Bootloader 的签名（若支持安全启动），防止加载恶意代码。
#### 1.2存储设备检测与初始化
##### 1.2.1检测启动介质
- 根据芯片引脚配置（如启动模式选择引脚），判断从何种设备启动（如 eMMC、SPI Flash、SD 卡、USB 等）。
##### 1.2.2初始化存储控制器
- 配置对应存储设备的控制器（如 SD/MMC 控制器、SPI 控制器），设置通信参数（如时钟频率、数据位宽）。
- 执行必要的设备探测与校准（如 SD 卡初始化、NAND Flash 坏块检测）。
#### 1.3加载SPL
##### 1.3.1定位 Bootloader
- 从选定的存储设备中读取特定位置的代码（如 eMMC 的前 4KB 扇区、SPI Flash 的起始地址）。
- 部分芯片支持多阶段查找（如先尝试从 eMMC 加载，失败则尝试 SD 卡）。
##### 1.3.2传输到内存
- 将第一阶段 Bootloader（如 SPL）加载到内部 SRAM 或外部 DDR 中。
- 加载地址由芯片厂商预定义（如 ARM Cortex-A 系列通常加载到 0x0 地址）。
##### 1.3.3验证与解压缩
- 若 Bootloader 被压缩，执行解压缩操作（如解压缩 LZMA 格式的 SPL）。
- 验证加载内容的完整性（如 CRC 校验、哈希验证），确保无数据损坏。
#### 1.4移交控制权
##### 1.4.1设置执行环境
- 配置 CPU 寄存器，设置栈指针（SP）和程序计数器（PC）。
- 切换 CPU 工作模式（如从复位模式切换到特权模式）。
##### 1.4.2跳转到 Bootloader
- 通过汇编指令（如 ARM 的`BX`指令）将控制权转移给加载的第一阶段 Bootloader，开始执行用户代码。
---
## 2.SPL
>完成最底层硬件初始化，加载完整 U-Boot 到内存并启动。

#### 2.1硬件基础初始化
- 配置时钟系统（如 PLL、分频器），设置 CPU 主频（如 1GHz）。
- 初始化看门狗、定时器等基本外设。
- 关闭中断和 MMU（内存管理单元），确保直接访问物理内存。
#### 2.2 内存控制器初始化
- 配置 DDR/DDR2/DDR3 控制器，设置时序参数（如 CAS 延迟、行 / 列地址周期）。
- 执行内存自测试（如写入 / 读取模式），验证内存稳定性。
#### 2.3 初始化存储设备
- 初始化 SD/MMC 控制器、SPI Flash 控制器等，为加载 U-Boot 做准备。
#### 2.4加载完整 U-Boot
- 从存储介质（如 eMMC、NAND Flash）读取完整 U-Boot 镜像到 DDR 内存。
- 校验 U-Boot 镜像完整性（如 CRC 校验、哈希验证）。
#### 2.5环境变量初始化
- 读取并解析环境变量（若已存在），为第二阶段提供配置参数。
#### 2.6跳转到第二阶段
- 设置栈指针（SP）和程序计数器（PC），将控制权移交至完整 U-Boot 的入口地址。

---
## 3.UBoot
> 提供丰富功能，加载并启动 Linux 内核。

#### 3.1硬件设备全面初始化
- 初始化 SPL 未处理的设备（如串口、以太网、USB、LCD）。
- 注册设备驱动，建立设备树（Device Tree）映射关系。
#### 3.2环境变量处理
- 加载默认环境变量（存储在 U-Boot 源码中）。
- 从非易失存储（如 Flash）读取用户自定义环境变量，覆盖默认值。
#### 3.3 用户交互界面
- 启动命令行解释器（CLI），提供交互式控制台（如通过串口输入命令）。
- 支持倒计时（如 “Hit any key to stop autoboot: 3”），允许用户干预自动启动流程。
#### 3.4 内核加载准备
- 根据环境变量（如bootargs）配置内核启动参数（如根文件系统位置、串口参数）。
- 从存储设备或网络（如 TFTP、NFS）加载 Linux 内核镜像（如zImage、Image）和设备树文件（.dtb）到内存。
#### 3.5内核启动
- 设置内核启动所需的寄存器（如传递设备树地址、启动参数地址）。
- 跳转到内核入口地址，触发内核执行（如 ARM 的theKernel()函数调用）。

---
---